数据库出了问题，一直返回错误 SQL error: database is locked，不能删除也不能新增数据，更新数据也不可以，软件里显示都快下载完成了，结果看数据库发现没有变化，但文件层面的没有异常，还是下载完成了。可能是删除导致的问题。

deleteTaskModel 方法里的事务结尾没有提交，导致有一个事务一直在进行。。。包括删除之后不能添加新数据，应该也是因为这个问题，deleteTaskSetModel 方法里的事务结尾没有提交。

删除了前面的数据后，后面紧挨着的数据很有可能会被 Scheduler 调度出 downloader 和 downloadTimer，造成后面的删除出错，比如在清除掉资源之后开始删除数据库中的数据，这时调度器为任务分配了新的资源，然后开始写数据库，这时会造成事务冲突，所以暂停和删除任务的时候从后向前删除。数组默认的 sort 和我的预期不一样，它优先看的不是长度，是首字母。

我忘记了自己的设计，中途还修改了 finishDownloadTask 函数，想让他更兼容，结果造成了 Done 的事件处理出错了，这些任务的 downloader 不应该被摧毁，导致了 bad fd 的错误，最后我新增了一个 pauseDownloadTask 函数，把功能区分开。

还是有错误，全都暂停了再删除也会有错误。如果所有的数据都处于 Waiting 状态，怎么删除都不会有错误，说明就是数据删除的事务~~卡住了~~，不是卡住了，是一直有更新事件在执行，和其他的下载的更新数据库操作有冲突，后面再删除就会报 database is locked 错误。看了 Sequence 的 logging，是因为暂停的时候 task_set 的 timer 没有关闭。

上了连接池也没有用，后来发现 transaction 中，对 Sequence 的查找没有添加到事务中，~~两者结合，就是解决方案~~还是不行[晕]。连接池可以加快效率，但冲突依然存在。

有三种解决方案可以一试，第一就是看看可不可以改锁的级别，行锁和表锁，也和事务息息相关，第二就是不停地 retry 事务，估计是没什么用。第三种就是 paranoid 逻辑删除。

Sequence 的事务隔离级别设置为最高级别的幻读有些用，可以减少出错误的概率。

Delete 不存在的数据，数据库不报错。

我的这么多数据库操作其实可以合并到一起去删除，每个表分开，甚至可能都可以多个表一起删除，但是还是有出错的可能，因为缩表的问题。用了同时删除多条数据，出错率应该大大减小了，
