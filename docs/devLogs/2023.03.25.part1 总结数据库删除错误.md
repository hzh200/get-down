前两天多一直在试图解决 http-downloader 删除操作总失败的问题，搞得我挫败感非常强，心灰意冷，课都不太想去上，今天来对问题和我做的解决措施做一下总结，后面如果还有这个问题，可以来参考这个日志。

新增，修改都没有问题，只是到了删除的时候，有时会出现在删除一个列表的时候，删除到随机的数据的时候会卡住，输出打印日志后，发现是出现了 database is locked 的错误，有时也出现找不到 sequence 的错误（在删除的事务中）。还因为代码的问题暂时出现过 bad fd 的问题。

找不到 sequence 的错误很有可能是代码逻辑的错误，可能是因为我把 taskSet 的 children 给 reverse 导致的，后续我创建了两个函数，只返回一个浅拷贝，内容都是整数，所以这种情况也无所谓。后续暂时没有出现过这个错误。

关于数据库锁的问题，最开始的处理逻辑是每个任务一个事务，删除所有的 task 和 sequence，输出日志发现，在多个序列化的事务中，有时某一个事务在执行的时候可以明显看到第一个删除操作反复执行，中间穿插着其他数据的更新操作，在重复几次后，sequelize 返回锁的错误。

我做过的解决措施有把事务全部换成可序列化，不过其他的数据库操作我没有换成事务。我还试过连接池，也会出现这样的错误。最后我把删除的操作都合在一起，尝试了几次，没有出现错误，我感觉也只是出错的概率减小了。

#### 相关的知识点和问题：

Sqlite 的锁的粒度是库级别的，我的删除操作怎么会和更新数据的操作交错进行？或许是 Sqlite 的机制。如果是其他支持更细力度的锁（fine-grained），应该没有这么多错误。

只有一个进程，为什么会有数据库操作的冲突？

Sqlite 删除数据不会有错误，没有符合删除的数据的时候，返回影响的行数为 0，除非子查询出错或者 SQL 语句有错误。

Sequelize 支持乐观锁，需要在表里添加一列 count；也支持 paranoid（逻辑删除也叫软删除），不过应该也需要自定义一列。